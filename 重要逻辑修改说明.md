# 重要逻辑修改说明

## 📋 修改日期
2026-01-26

## 🎯 修改目标

将"每个板块TOP 5"的筛选逻辑改为"跨板块总共TOP 15"，并确保数据库保存所有翻译和评论过的新闻。

## 🔄 修改前的逻辑

### 问题
1. **筛选时机过早**：在翻译后立即筛选TOP 15
2. **数据丢失**：只有进入TOP 15的新闻才会被保存到数据库
3. **板块平均分配**：每个板块TOP 5（domestic 5 + asia_pacific 5 + us_europe 5）

### 旧流程
```
1. 抓取新闻（150条）
2. 去重检查
3. 翻译新新闻（假设50条）
4. 【问题】立即筛选TOP 15（每个板块5条）
5. 只为TOP 15的新新闻生成AI评论
6. 只保存TOP 15到数据库 ❌ 数据丢失
7. 生成HTML（显示TOP 15）
```

### 示例
- 抓取150条新闻
- 去重后50条新新闻
- 筛选TOP 15（每个板块5条）
- **只有这15条被保存** ❌
- 其他35条新新闻被丢弃

## ✨ 修改后的逻辑

### 改进
1. **数据完整保存**：所有翻译和评论过的新闻都保存到数据库
2. **延迟筛选**：先保存，再筛选用于显示
3. **智能评分**：跨板块根据重要性评分，取TOP 15
4. **板块平衡**：尽量确保3个板块都有代表

### 新流程
```
1. 抓取新闻（150条）
2. 去重检查：分离新新闻和缓存新闻
3. 翻译所有新新闻（50条）
4. 为所有新新闻生成AI评论
5. 【改进】保存所有新新闻到数据库 ✅ 数据完整
6. 【改进】合并新新闻 + 缓存新闻
7. 从所有新闻中筛选TOP 15（用于HTML显示）
8. 生成HTML（只显示TOP 15）
9. 更新首页
```

### 示例
- 抓取150条新闻
- 去重后50条新新闻 + 100条缓存新闻
- 翻译并评论所有50条新新闻
- **保存所有50条新新闻到数据库** ✅
- 从150条（50新 + 100缓存）中筛选TOP 15
- 生成HTML显示TOP 15

## 📊 TOP 15筛选算法

### 评分规则（总分最高110分）

| 因素 | 得分 | 说明 |
|------|------|------|
| **新新闻** | +50分 | 优先展示今天抓取的新闻 |
| **有AI评论** | +20分 | 有评论的新闻更重要 |
| **发布时间** | 0-30分 | 越新越好：<6h(+30), <12h(+20), <24h(+10), <48h(+5) |
| **已翻译** | +10分 | 英文新闻已翻译 |
| **板块平衡** | 特殊处理 | 确保每个板块至少有1条（如果可能）|

### 算法流程

1. **计算得分**：为每条新闻计算综合得分
2. **排序**：按得分倒序排列
3. **初筛**：取前15条
4. **板块平衡**：如果某个板块没有新闻，用后续新闻替换

### 板块分布示例

**理想情况**：
- domestic: 5条
- asia_pacific: 5条
- us_europe: 5条

**实际情况**（取决于新闻源）：
- domestic: 4条
- asia_pacific: 6条
- us_europe: 5条

## 💾 数据库策略

### 保存内容
- ✅ **所有**翻译过的新闻
- ✅ **所有**有AI评论的新闻
- ✅ 新新闻 + 缓存新闻

### 显示内容
- ✅ HTML只显示TOP 15
- ✅ 数据库保存所有新闻

### 查询统计
```python
# 查看数据库中有多少条新闻
stats = db_manager.get_stats()
# 总记录: 165条
# 已翻译: 89条
# 有AI评论: 165条

# 但HTML只显示TOP 15
```

## 🎯 优势对比

| 指标 | 修改前 | 修改后 |
|------|--------|--------|
| **数据保存** | 只保存TOP 15 ❌ | 保存所有新闻 ✅ |
| **数据完整性** | 丢失90%数据 ❌ | 零丢失 ✅ |
| **筛选逻辑** | 板块平均（5+5+5） | 智能评分（TOP 15） |
| **HTML显示** | 15条 | 15条 |
| **板块平衡** | 强制平衡 | 智能平衡 |
| **数据库价值** | 低（只有TOP 15） | 高（所有历史） |

## 📈 实际效果

### 运行1（第一天）
- 抓取：150条
- 新新闻：50条
- 保存：50条 ✅
- HTML显示：TOP 15

### 运行2（第二天）
- 抓取：150条
- 新新闻：45条
- 缓存：50条（昨天的）
- 保存：45条 ✅
- 数据库总计：95条 ✅
- HTML显示：从95条中筛选TOP 15

### 运行30（一个月后）
- 抓取：150条
- 新新闻：40条
- 缓存：1000+条（历史）
- 保存：40条 ✅
- 数据库总计：1000+条 ✅
- HTML显示：从1000+条中筛选TOP 15（最优质的）

## 🔧 配置选项

### 修改TOP N数量

在 `main.py` 第190行修改：

```python
top_15_news = select_top_news(all_articles, top_n=15)  # 改为你想要的数量
```

例如：
- `top_n=10` - 只显示10条
- `top_n=20` - 显示20条
- `top_n=30` - 显示30条

### 修改评分规则

在 `main.py` 第31-109行的 `select_top_news` 函数中修改评分逻辑。

## ⚠️ 注意事项

1. **数据库增长**：数据库会持续增长，需要定期清理旧数据
2. **HTML大小**：HTML文件保持较小（只有15条新闻）
3. **筛选时间**：从1000+条中筛选TOP 15需要更多计算时间（但仍在秒级）
4. **缓存命中**：随着数据库增长，缓存命中率会提高，API调用会减少

## 📝 后续优化建议

1. **定期清理**：每月清理30天以前的数据库记录
2. **缓存预热**：启动时预加载TOP 100到内存
3. **增量更新**：只重新计算新新闻的得分
4. **热门新闻**：增加"本周热门"或"本月热门"榜单

---

**修改人员**：Vincent + Claude Code
**修改日期**：2026-01-26
**版本**：v2.1
**状态**：✅ 已实施并测试
