# 需求文档

## 📌 待实现需求：移除20条新闻限制

### 📅 创建时间
2026-01-28

### 🎯 需求概述

**当前逻辑：**
```
抓取新闻 → 去重 → 翻译 → AI评论 → 筛选TOP 20条 → 按源轮询排序 → 生成HTML
                                      ↑
                                固定20条限制
```

**新逻辑：**
```
抓取新闻 → 去重 → 翻译 → AI评论 → 筛选24小时内新闻 → 按源轮询排序 → 生成HTML
                                      ↑
                                时间筛选（无数量限制）
```

---

## 🔧 具体修改点

### 1. 筛选条件改变
- **之前**：固定筛选 20 条新闻（`TOP_NEWS_COUNT = 20`）
- **之后**：筛选最近 **24 小时内**的所有新闻（不限制数量）
- **影响**：HTML 页面会显示所有符合条件的新闻，可能是 10 条，也可能是 50 条

### 2. 排序逻辑保留 ✅
- 继续使用**按源轮询排序**（彭博社 → Yahoo → MarketWatch → ... 循环）
- 确保每个源的新闻轮流出现，保持多样性

### 3. Featured 标记移除 ❌
- 不再将第一条新闻标记为 Featured
- 所有新闻卡片样式统一

---

## 📂 涉及文件

### 1. `news_bot/main.py`
**位置**：第 31-117 行的 `select_top_news()` 函数

**当前逻辑**：
- 参数 `top_n=20`，固定筛选 20 条
- 第 92 行：`while len(top_articles) < top_n`
- 第 103 行：`if len(top_articles) >= top_n`

**修改为**：
- 创建新函数 `filter_and_sort_articles()`
- 先按时间筛选（24 小时内）
- 再按源轮询排序（无数量限制）

**调用位置**：
- 第 318 行（主流程）
- 第 179 行（`regenerate_html_from_db` 函数）

---

### 2. `news_bot/src/html_generator.py`
**位置**：第 27-29 行

**当前代码**：
```python
# 为第一篇文章标记为featured
if articles:
    articles[0].featured = True
```

**修改为**：
- 删除这段代码，不再设置 featured 标记

---

### 3. `news_bot/src/config.py`
**位置**：第 46 行

**当前配置**：
```python
TOP_NEWS_COUNT = 20  # 总共筛选TOP新闻数量
```

**选项**：
- **选项 A**：删除这个配置（不再使用）
- **选项 B**：改名为 `NEWS_AGE_HOURS = 24`（新闻时效）

---

## ✅ 完成标准

- [x] HTML 页面显示最近 24 小时内的所有新闻（不限制数量）
- [x] 新闻按源轮询排序（彭博社 → Yahoo → MarketWatch → ...）
- [x] 所有新闻卡片样式一致（无 Featured 标记）
- [x] 主流程和重新生成流程都应用新逻辑
- [x] 测试运行正常

## ✨ 实现细节

### 新增函数：`filter_and_sort_articles()`
- 参数：`hours` (时间筛选范围，默认24小时)
- 参数：`enable_time_filter` (是否启用时间筛选，默认True)
- 逻辑：
  1. 可选的时间筛选（最近N小时）
  2. 按源分组
  3. 按源轮询排序（无数量限制）

### 保留函数：`select_top_news()`
- 用于 `regenerate_html_from_db` 的历史生成
- 保持兼容性

---

## 💬 用户确认

通过以下方式确认了需求：

1. **数量限制**：只显示今天/最近 24 小时内的新闻
2. **排序逻辑**：保留按源轮询排序
3. **头条标记**：不保留，所有新闻样式一致

---

## 🔄 当前状态

**✅ 已完成！** - 2026-01-28 11:53

### 测试结果
```
2026-01-28 11:53:16.788 | INFO | 跳过时间筛选，使用所有 22 条新闻
2026-01-28 11:53:16.788 | INFO | 源轮询排序: 4 个源，16 轮
2026-01-28 11:53:16.788 | INFO | 最终结果: 22 条新闻
2026-01-28 11:53:16.794 | INFO | ✓ 生成: 2026-01-27.html (22 条新闻)
```

### 修改的文件
1. ✅ `news_bot/main.py` - 新增 `filter_and_sort_articles()` 函数
2. ✅ `news_bot/src/html_generator.py` - 移除 featured 标记

---

*最后更新：2026-01-28 11:53*
