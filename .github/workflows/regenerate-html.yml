name: é‡æ–°ç”ŸæˆHTML

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      days:
        description: 'è¯»å–æœ€è¿‘Nå¤©çš„æ–°é—»'
        required: false
        default: '7'
        type: choice
        options:
          - 7
          - 14
          - 30

jobs:
  regenerate:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽæŽ¨é€åˆ°mainåˆ†æ”¯

    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        cd news_bot
        pip install -r requirements.txt

    - name: è®¾ç½®çŽ¯å¢ƒå˜é‡
      run: |
        cd news_bot
        # åˆ›å»º.envæ–‡ä»¶
        cat > .env << EOF
        ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
        ANTHROPIC_BASE_URL=${{ secrets.ANTHROPIC_BASE_URL }}
        CLAUDE_MODEL=claude-3-5-sonnet-20241022
        MAX_AGE_HOURS=48
        TOP_NEWS_PER_CATEGORY=5
        EOF

    - name: é‡æ–°ç”ŸæˆHTML
      run: |
        cd news_bot
        echo "ðŸ”„ å¼€å§‹é‡æ–°ç”ŸæˆHTMLï¼ˆæœ€è¿‘ ${{ inputs.days }} å¤©ï¼‰"
        python main.py --html-only --days ${{ inputs.days }}

    - name: é…ç½®Gitç”¨æˆ·
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github'

    - name: æäº¤å¹¶æŽ¨é€HTMLæ–‡ä»¶
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
        if [ -n "$(git diff --name-only public/)" ]; then
          git add public/*.html
          git diff --staged --quiet || git commit -m "ðŸ”„ é‡æ–°ç”ŸæˆHTML - $(date +'%Y-%m-%d %H:%M:%S') (æœ€è¿‘${{ inputs.days }}å¤©)"
          git pull origin main --no-rebase
          git push origin main
          echo "âœ“ HTMLæ–‡ä»¶å·²æ›´æ–°å¹¶æŽ¨é€"
        else
          echo "â„¹ï¸ æ²¡æœ‰HTMLæ–‡ä»¶éœ€è¦æ›´æ–°"
        fi

    - name: è§¦å‘Verceléƒ¨ç½²
      if: success()
      run: |
        echo "âœ“ HTMLæ–‡ä»¶å·²æŽ¨é€åˆ°mainåˆ†æ”¯"
        echo "âœ“ Vercelå°†è‡ªåŠ¨æ£€æµ‹å¹¶éƒ¨ç½²"
        echo "âœ“ è®¿é—®ä½ çš„Vercelä»ªè¡¨æ¿æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€"
