name: é‡æ–°ç”ŸæˆHTML

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      days:
        description: 'è¯»å–æœ€è¿‘Nå¤©çš„æ–°é—»'
        required: false
        default: '7'
        type: choice
        options:
          - 7
          - 14
          - 30
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆæ¯ä¸ªæºåªæŠ“1æ¡æ–°é—»ï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  regenerate:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        cd news_bot
        pip install -r requirements.txt

    - name: ç¼“å­˜æ•°æ®åº“æ–‡ä»¶
      uses: actions/cache@v4
      with:
        path: news_bot/data/news.db
        # âœ… ä¿®å¤ï¼šç¼“å­˜ key ä¸è¦ç”¨ run_idï¼ˆä¼šå¯¼è‡´ç»å¸¸æ¡åˆ°æ—§ DBï¼‰
        # æ”¹æˆæŒ‰åˆ†æ”¯å›ºå®šï¼Œå½¢æˆ"åŒä¸€æ¡ç¼“å­˜é“¾"ï¼Œæ¯æ¬¡è¿è¡Œéƒ½ä¼šæ›´æ–°åŒä¸€ä¸ªç¼“å­˜
        key: news-db-${{ runner.os }}-${{ github.ref_name }}
        restore-keys: |
          news-db-${{ runner.os }}-
          news-db-

    - name: Debug DB file info
      run: |
        ls -lah news_bot/data || true
        ls -lah news_bot/data/news.db || true
        du -h news_bot/data/news.db || true

    - name: è®¾ç½®çŽ¯å¢ƒå˜é‡
      run: |
        cd news_bot
        # åˆ›å»º.envæ–‡ä»¶
        cat > .env << EOF
        ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
        ANTHROPIC_BASE_URL=${{ secrets.ANTHROPIC_BASE_URL }}
        CLAUDE_MODEL=claude-3-5-sonnet-20241022
        MAX_AGE_HOURS=48
        TOP_NEWS_PER_CATEGORY=5
        EOF

    - name: é‡æ–°ç”ŸæˆHTML
      run: |
        cd news_bot
        # å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„å¤©æ•°ï¼Œå¦åˆ™é»˜è®¤7å¤©
        DAYS="${{ inputs.days || '7' }}"
        TEST_MODE="${{ inputs.test_mode || 'false' }}"
        echo "ðŸ”„ å¼€å§‹é‡æ–°ç”ŸæˆHTMLï¼ˆæœ€è¿‘ $DAYS å¤©ï¼‰"
        if [ "$TEST_MODE" = "true" ]; then
          echo "ðŸ§ª æµ‹è¯•æ¨¡å¼å¯ç”¨ï¼šæ¯ä¸ªæºåªæŠ“å–1æ¡æ–°é—»"
          python main.py --test
        else
          python main.py --html-only --days "$DAYS"
        fi

    - name: å®‰è£… Vercel CLI
      if: success()
      run: npm install --global vercel@latest

    - name: éƒ¨ç½²åˆ° Vercel
      if: success()
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      run: |
        # åœ¨ CI ä¸­ç”¨ secrets æŒ‡å®šçš„ Org/Project ç»‘å®šï¼Œé¿å…é»˜è®¤ç”¨ç›®å½•åï¼ˆæ¯”å¦‚ publicï¼‰åˆ›å»ºæ–°é¡¹ç›®
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "ðŸ”— ç»‘å®šåˆ° Vercel Project (production)..."
          vercel pull --yes --environment=production --token="$VERCEL_TOKEN"
          echo "ðŸš€ æ­£åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ (Production)..."
          vercel deploy ./public --prod --name daily-news-bot --token="$VERCEL_TOKEN" --yes
        else
          echo "ðŸ”— ç»‘å®šåˆ° Vercel Project (preview)..."
          vercel pull --yes --environment=preview --token="$VERCEL_TOKEN"
          echo "ðŸ§ª æ­£åœ¨éƒ¨ç½²åˆ°æµ‹è¯•é¢„è§ˆçŽ¯å¢ƒ (Preview)..."
          # ä¸å¸¦ --prod å‚æ•°ï¼ŒVercel ä¼šç”Ÿæˆä¸€ä¸ªä¸´æ—¶é¢„è§ˆé“¾æŽ¥
          vercel deploy ./public --name daily-news-bot --token="$VERCEL_TOKEN" --yes
        fi

    - name: éƒ¨ç½²å®Œæˆæç¤º
      if: success()
      run: |
        echo "âœ… HTML æ–‡ä»¶å·²ç›´æŽ¥éƒ¨ç½²åˆ° Vercel"
        echo "âœ… æœªæäº¤åˆ° GitHub ä»“åº“"
        echo "âœ… æ•°æ®åº“å·²ç¼“å­˜åˆ° GitHub Actions"
