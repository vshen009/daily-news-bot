name: æ¯æ—¥è´¢ç»æ–°é—»ç”Ÿæˆ

on:
  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTC 0ç‚¹ã€6ç‚¹ã€12ç‚¹ã€18ç‚¹ï¼‰
  schedule:
    - cron: '0 */6 * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # å¯é€‰ï¼šæŽ¨é€åˆ°mainåˆ†æ”¯æ—¶ä¹Ÿè¿è¡Œï¼ˆæµ‹è¯•ç”¨ï¼‰
  # push:
  #   branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œç”¨äºŽæŽ¨é€åˆ°mainåˆ†æ”¯

    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        cd news_bot
        pip install -r requirements.txt

    - name: è®¾ç½®çŽ¯å¢ƒå˜é‡
      run: |
        cd news_bot
        # åˆ›å»º.envæ–‡ä»¶
        cat > .env << EOF
        ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
        ANTHROPIC_BASE_URL=${{ secrets.ANTHROPIC_BASE_URL }}
        CLAUDE_MODEL=claude-3-5-sonnet-20241022
        MAX_AGE_HOURS=48
        TOP_NEWS_PER_CATEGORY=5
        EOF

    - name: è¿è¡Œæ–°é—»æŠ“å–
      run: |
        cd news_bot
        python main.py

    - name: é…ç½®Gitç”¨æˆ·
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'

    - name: æäº¤å¹¶æŽ¨é€HTMLæ–‡ä»¶
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶
        if [ -f "public/$(date +%Y-%m-%d).html" ]; then
          git add public/*.html
          git diff --staged --quiet || git commit -m "ðŸ“° æ¯æ—¥æ–°é—»æ›´æ–° - $(date +'%Y-%m-%d')"
        else
          echo "è­¦å‘Šï¼šæœªç”Ÿæˆä»Šæ—¥HTMLæ–‡ä»¶"
          exit 1
        fi

    - name: åˆ›å»º Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        branch: automated-news-update-$(date +'%Y%m%d')
        title: "ðŸ“° æ¯æ—¥æ–°é—»æ›´æ–° - $(date +'%Y-%m-%d')"
        body: |
          ## ðŸ“° è‡ªåŠ¨ç”Ÿæˆçš„æ–°é—»æ›´æ–°

          è¿™æ˜¯ä¸€ä¸ªç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºçš„ PRï¼ŒåŒ…å«æœ€æ–°çš„è´¢ç»æ–°é—»ã€‚

          ### æ›´æ–°å†…å®¹
          - ç”Ÿæˆæ—¥æœŸï¼š$(date +'%Y-%m-%d')
          - è‡ªåŠ¨æŠ“å–å¹¶ç¿»è¯‘æœ€æ–°è´¢ç»æ–°é—»
          - æ›´æ–°é¦–é¡µå’Œæ—¥æŠ¥ HTML æ–‡ä»¶

          ---

          ðŸ¤– ç”± [Daily News Bot](https://github.com/vshen009/daily-news-bot) è‡ªåŠ¨ç”Ÿæˆ
        commit-message: "ðŸ“° æ¯æ—¥æ–°é—»æ›´æ–° - $(date +'%Y-%m-%d')"
        labels: automated, daily-news
        delete-branch: true

    - name: æç¤ºä¿¡æ¯
      if: success()
      run: |
        echo "âœ“ Pull Request å·²åˆ›å»º"
        echo "âœ“ è¯·æ£€æŸ¥å¹¶åˆå¹¶ PR ä»¥éƒ¨ç½²åˆ° Vercel"
        echo "âœ“ åˆå¹¶åŽ Vercel å°†è‡ªåŠ¨éƒ¨ç½²"
