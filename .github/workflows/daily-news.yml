name: æ¯æ—¥è´¢ç»æ–°é—»ç”Ÿæˆ

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 07:05ï¼ˆUTC 23:05ï¼‰
    - cron: '5 23 * * *'
    # åŒ—äº¬æ—¶é—´ 12:05ï¼ˆUTC 04:05ï¼‰
    - cron: '5 4 * * *'
    # åŒ—äº¬æ—¶é—´ 18:05ï¼ˆUTC 10:05ï¼‰
    - cron: '5 10 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4      

      - name: Time sanity check
        run: |
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Runner now (default date):"; date
          echo "UTC now:"; date -u
          echo "TZ env: $TZ"
          python - <<'PY'
          import os, time
          from datetime import datetime, timezone
          from zoneinfo import ZoneInfo
          print("python now():", datetime.now())
          print("python now(utc):", datetime.now(timezone.utc))
          print("python now(Asia/Shanghai):", datetime.now(ZoneInfo("Asia/Shanghai")))
          print("time.tzname:", time.tzname)
          print("TZ env:", os.getenv("TZ"))
          PY

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          cd news_bot
          pip install -r requirements.txt

      - name: ç¼“å­˜æ•°æ®åº“æ–‡ä»¶
        uses: actions/cache@v4
        with:
          path: news_bot/data/news.db
          # key å†³å®šäº†æœ¬æ¬¡è¿è¡Œäº§ç”Ÿçš„ç¼“å­˜å«ä»€ä¹ˆåå­—
          key: news-db-${{ runner.os }}-${{ github.run_id }}
          # restore-keys å†³å®šäº†å¦‚æœ key æ²¡å‘½ä¸­ï¼Œå»æ¡å“ªä¸€ä¸ªæ—§ç¼“å­˜æ¥ç”¨
          restore-keys: |
            news-db-${{ runner.os }}-
            news-db-

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          cd news_bot
          # åˆ›å»º .env æ–‡ä»¶
          cat > .env << EOF
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL=${{ secrets.ANTHROPIC_BASE_URL }}
          CLAUDE_MODEL=claude-3-5-sonnet-20241022
          MAX_AGE_HOURS=48
          TOP_NEWS_PER_CATEGORY=5
          EOF

      - name: è¿è¡Œæ–°é—»æŠ“å–
        run: |
          cd news_bot
          python main.py

      # âœ… ä¿®å¤ï¼šå…ˆå®‰è£… Vercel CLIï¼ˆå¦åˆ™ä¼šå‡ºç° vercel: command not foundï¼‰
      - name: å®‰è£… Vercel CLI
        run: |
          npm install -g vercel@latest
          vercel --version

      - name: éƒ¨ç½²åˆ° Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          # åœ¨ CI ä¸­ç”¨ secrets æŒ‡å®šçš„ Org/Project ç»‘å®šï¼Œé¿å…é»˜è®¤ç”¨ç›®å½•åï¼ˆæ¯”å¦‚ publicï¼‰åˆ›å»ºæ–°é¡¹ç›®
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ğŸ”— ç»‘å®šåˆ° Vercel Project (production)..."
            vercel pull --yes --environment=production --token="$VERCEL_TOKEN"
            echo "ğŸš€ æ­£åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ (Production)..."
            vercel deploy ./public --prod --token="$VERCEL_TOKEN" --yes
          else
            echo "ğŸ”— ç»‘å®šåˆ° Vercel Project (preview)..."
            vercel pull --yes --environment=preview --token="$VERCEL_TOKEN"
            echo "ğŸ§ª æ­£åœ¨éƒ¨ç½²åˆ°æµ‹è¯•é¢„è§ˆç¯å¢ƒ (Preview)..."
            # ä¸å¸¦ --prod å‚æ•°ï¼ŒVercel ä¼šç”Ÿæˆä¸€ä¸ªä¸´æ—¶é¢„è§ˆé“¾æ¥
            vercel deploy ./public --token="$VERCEL_TOKEN" --yes
          fi

      - name: éƒ¨ç½²å®Œæˆæç¤º
        run: |
          echo "âœ… HTML æ–‡ä»¶å·²ç›´æ¥éƒ¨ç½²åˆ° Vercel"
          echo "âœ… æœªæäº¤åˆ° GitHub ä»“åº“"
          echo "âœ… æ•°æ®åº“å·²ç¼“å­˜åˆ° GitHub Actions"
