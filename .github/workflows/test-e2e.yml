name: ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰

on:
  # ä»…å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        cd news_bot
        pip install -r requirements.txt

    - name: è®¾ç½®çŽ¯å¢ƒå˜é‡
      run: |
        cd news_bot
        # åˆ›å»º.envæ–‡ä»¶
        cat > .env << EOF
        ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
        ANTHROPIC_BASE_URL=${{ secrets.ANTHROPIC_BASE_URL }}
        CLAUDE_MODEL=claude-3-5-sonnet-20241022
        MAX_AGE_HOURS=48
        TOP_NEWS_PER_CATEGORY=5
        EOF

    - name: è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
      run: |
        cd news_bot
        python test_e2e.py

    - name: é…ç½®Gitç”¨æˆ·
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'

    - name: æäº¤HTMLæ–‡ä»¶
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„HTMLæ–‡ä»¶ç”Ÿæˆ
        if [ -n "$(git status --porcelain public/)" ]; then
          git add public/*.html news_bot/data/news.db
          git commit -m "ðŸ§ª ç«¯åˆ°ç«¯æµ‹è¯• - $(date +'%Y-%m-%d %H:%M')"
        else
          echo "æ²¡æœ‰æ–°çš„HTMLæ–‡ä»¶éœ€è¦æäº¤"
          exit 0
        fi

    - name: åˆ›å»ºå¹¶è‡ªåŠ¨åˆå¹¶ Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        branch: test-e2e-$(date +'%Y%m%d-%H%M%S')
        title: "ðŸ§ª ç«¯åˆ°ç«¯æµ‹è¯• - $(date +'%Y-%m-%d %H:%M')"
        body: |
          ## ðŸ§ª ç«¯åˆ°ç«¯æµ‹è¯• PR

          è¿™æ˜¯ä¸€ä¸ªç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºçš„æµ‹è¯• PRã€‚

          ### æµ‹è¯•å†…å®¹
          - æµ‹è¯•æ—¥æœŸï¼š$(date +'%Y-%m-%d %H:%M:%S')
          - è¿è¡Œè„šæœ¬ï¼š`test_e2e.py`
          - æµ‹è¯•èŒƒå›´ï¼šæ¯ä¸ªæ–°é—»æºæŠ“å–1æ¡æ•°æ®
          - å®Œæ•´æµç¨‹ï¼šæŠ“å– â†’ åŽ»é‡ â†’ ç¿»è¯‘ â†’ AIè¯„è®º â†’ è¯„åˆ† â†’ ç”ŸæˆHTML â†’ æ›´æ–°é¦–é¡µ

          ### æ›´æ–°æ–‡ä»¶
          - æµ‹è¯•ç”Ÿæˆçš„ HTML æ–‡ä»¶
          - æ•°æ®åº“æ–‡ä»¶ï¼ˆå¦‚æœ‰æ›´æ–°ï¼‰

          ---

          ðŸ¤– ç”± [GitHub Actions](https://github.com/vshen009/daily-news-bot/actions) è‡ªåŠ¨åˆ›å»º
        commit-message: "ðŸ§ª ç«¯åˆ°ç«¯æµ‹è¯• - $(date +'%Y-%m-%d %H:%M')"
        labels: automated, test, e2e
        auto-merge: "merge"
        delete-branch: true

    - name: å®Œæˆæç¤º
      if: success()
      run: |
        echo "âœ… ç«¯åˆ°ç«¯æµ‹è¯•å®Œæˆ"
        echo "âœ… PR å·²åˆ›å»ºå¹¶è‡ªåŠ¨åˆå¹¶"
        echo "âœ… Vercel å°†è‡ªåŠ¨éƒ¨ç½²æ›´æ–°"
